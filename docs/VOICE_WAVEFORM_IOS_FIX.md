# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ iOS

## –ü—Ä–æ–±–ª–µ–º–∞
–ù–∞ iPhone –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ waveform (–≤–æ–ª–Ω—ã) –≤ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.

## –ü—Ä–∏—á–∏–Ω—ã
1. **TouchableWithoutFeedback**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `TouchableWithoutFeedback`, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞ iOS –Ω–µ –≤—Å–µ–≥–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–ª–æ–∂–µ–Ω –≤ –¥—Ä—É–≥–æ–π Touchable (`BubbleContainer`)
2. **–ü–µ—Ä–µ—Ö–≤–∞—Ç —Å–æ–±—ã—Ç–∏–π**: `BubbleContainer` —Å `TouchableOpacity` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª —Å–æ–±—ã—Ç–∏—è –Ω–∞–∂–∞—Ç–∏—è, –Ω–µ –¥–∞–≤–∞—è –∏–º –¥–æ–π—Ç–∏ –¥–æ waveform
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏**: –ù–∞ iOS –Ω–µ –±—ã–ª–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ waveform

## –†–µ—à–µ–Ω–∏–µ

### 1. CachedVoice.jsx

#### –ó–∞–º–µ–Ω–∞ TouchableWithoutFeedback –Ω–∞ Pressable
```javascript
// –ë—ã–ª–æ:
import { TouchableWithoutFeedback } from 'react-native';
<TouchableWithoutFeedback 
  onPress={handleWaveformPress}
  disabled={!soundRef.current}
>
  <View style={styles.waveformPressable} onLayout={handleWaveformLayout}>
    ...
  </View>
</TouchableWithoutFeedback>

// –°—Ç–∞–ª–æ:
import { Pressable } from 'react-native';
<Pressable 
  onPress={handleWaveformPress}
  disabled={!soundRef.current}
  style={({ pressed }) => [
    styles.waveformPressable,
    pressed && Platform.OS === 'ios' && { opacity: 0.7 }
  ]}
  hitSlop={{ top: 5, bottom: 5, left: 5, right: 5 }}
>
  <View style={styles.waveformWrapper} onLayout={handleWaveformLayout}>
    ...
  </View>
</Pressable>
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Pressable:**
- –õ—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iOS —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ touchable –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —á–µ—Ä–µ–∑ `pressed` state
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
- `hitSlop` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

#### –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –Ω–∞–∂–∞—Ç–∏–π
```javascript
const handleWaveformPress = useCallback((event) => {
  if (!soundRef.current || playbackDuration <= 0) return;
  
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
  if (event?.stopPropagation) {
    event.stopPropagation();
  }
  
  const { locationX, locationY } = event.nativeEvent || event;
  
  // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  if (__DEV__) {
    devLog('üéµ Waveform press:', { locationX, locationY, width });
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
}, [playbackDuration, progressAnim, playbackPosition, playbackRate]);
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `stopPropagation()` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—Å–ø–ª—ã—Ç–∏—è —Å–æ–±—ã—Ç–∏—è –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `event.nativeEvent`
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ)
- –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞–∂–∞—Ç–∏—è

#### –†–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª–µ–π
```javascript
// –ë—ã–ª–æ:
waveformPressable: {
  width: '100%',
  paddingTop: 0,
  paddingBottom: 0,
  justifyContent: 'center',
},
waveformBars: {
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  height: 18,
  gap: 1.5,
  marginTop: 7,
},

// –°—Ç–∞–ª–æ:
waveformPressable: {
  width: '100%',
  paddingVertical: 8, // –£–≤–µ–ª–∏—á–µ–Ω–∞ –æ–±–ª–∞—Å—Ç—å –Ω–∞–∂–∞—Ç–∏—è
},
waveformWrapper: {
  width: '100%',
},
waveformBars: {
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  height: 18,
  gap: 1.5,
  // marginTop —É–¥–∞–ª–µ–Ω - –Ω–µ –Ω—É–∂–µ–Ω —Å paddingVertical
},
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `waveformWrapper` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã
- `paddingVertical: 8` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –Ω–∞–∂–∞—Ç–∏—è
- –£–ø—Ä–æ—â–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∏–ª–µ–π

### 2. MessageBubble.jsx

#### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```javascript
// –ë—ã–ª–æ:
const canPress = isSelectionMode || hasContextMenu;

// –°—Ç–∞–ª–æ:
// –î–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –Ω–∞–∂–∞—Ç–∏–π –≤ BubbleContainer
const isVoiceMessage = text === '' && !hasImage && !replyTo;
const canPress = isSelectionMode || (hasContextMenu && !isVoiceMessage);
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –ø–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é —Ç–µ–∫—Å—Ç–∞, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ reply
- –î–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π `BubbleContainer` –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è (–¥–∞–∂–µ —Å `hasContextMenu`)
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ waveform –¥–æ—Ö–æ–¥–∏—Ç—å –¥–æ `CachedVoice`

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É Pressable –ª—É—á—à–µ TouchableWithoutFeedback –¥–ª—è iOS?

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: `Pressable` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π API React Native –∏ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
2. **–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å**: –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `pressed` state –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å**: –õ—É—á—à–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–æ–ø—Å—ã (`hitSlop`, `pressRetentionOffset`)
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ iOS

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞–∂–∞—Ç–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è:

```javascript
// 1. –ú—è–≥–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã —Å –¥–æ–ø—É—Å–∫–æ–º
const validLocationX = Math.max(-10, Math.min(width + 10, locationX));

// 2. –ñ–µ—Å—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è –ª–æ–∂–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
if (locationX < -20 || locationX > width + 20) return;

// 3. –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
if (locationY > maxValidY || locationY < -10) return;

// 4. –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –≤ –Ω–∞—á–∞–ª–æ
if (validLocationX < 3 && playbackPosition > 5) return;
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
1. ‚úÖ –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ waveform –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ
2. ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ (opacity: 0.7 –Ω–∞ iOS)
3. ‚úÖ –î–ª–∏–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –≤—Å–µ –µ—â–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
4. ‚úÖ –†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. ‚úÖ –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É play/pause —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
6. ‚úÖ –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
7. ‚úÖ –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Ç–∏–ø–∞—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (iPhone, iPad)

### –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- iPhone SE (–º–∞–ª—ã–π —ç–∫—Ä–∞–Ω)
- iPhone 14/15 (—Å—Ä–µ–¥–Ω–∏–π —ç–∫—Ä–∞–Ω)
- iPhone 14/15 Pro Max (–±–æ–ª—å—à–æ–π —ç–∫—Ä–∞–Ω)
- iPad (–ø–ª–∞–Ω—à–µ—Ç)

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- ‚úÖ –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iOS
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (hitSlop + paddingVertical)
- ‚úÖ –ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è–º–∏ (long press, selection mode)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `mobile/src/entities/chat/ui/CachedVoice/CachedVoice.jsx` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `mobile/src/entities/chat/ui/MessageBubble.jsx` - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
- `mobile/src/screens/chat/ui/DirectChatScreen.jsx` - —ç–∫—Ä–∞–Ω –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞
- `mobile/src/screens/chat/ui/GroupChatScreen.jsx` - —ç–∫—Ä–∞–Ω –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞

