## Chat (Mobile) — Test Plan (MVP)

Основано на `mobile/docs/CHATrequirements.md` и серверных документах. Цель — проверить ключевые пользовательские сценарии, устойчивость к ошибкам (401/429/офлайн), и базовую совместимость с сокетами.

## Предусловия
- На сервере включен чат (ENABLE_CHAT=true), миграции выполнены, API доступен.
- В БД есть минимум 2 пользователя (Client A/B) и 1 админ.
- На устройстве/эмуляторе установлено приложение, корректно настроены `BASE_URL` и авторизация.
- Push/Deep-link (опционально): при наличии — проверить переходы в чат по ссылкам вида `app://chat/room/{id}`.

## Данные/Аккаунты
- Client A (основной тестовый пользователь)
- Client B (второй клиент для P2P/группы)
- Admin (для проверки удаления сообщений «для всех» и управления участниками)

## Сценарии (ручные)

### 1. Список чатов
- Открыть `ChatList` → список отображается сразу из кэша (если был) и обновляется после загрузки.
- Свайп вниз — pull-to-refresh перезапрашивает 1-ю страницу.
- Доскроллить вниз — подгружается следующая страница (при наличии).
- В каждом элементе: аватар-заглушка, заголовок/название, превью последнего сообщения, время, бейдж непрочитанных (если реализован на сервере).

### 2. Комната чата
- Открыть `ChatRoom`: лента сообщений отображается `inverted`, последние сверху визуально.
- При достижении «верха» списка — догружаются старые сообщения (cursorId/`backward`).
- Отображение типов: TEXT, IMAGE (миниатюры + подпись), PRODUCT (карточка с «Открыть»).
- Метка времени и статус («галочки») у своих сообщений.
- У чужих сообщений — аватар слева.

### 3. Отправка сообщений
- TEXT: ввести текст в `Composer`, отправить — сообщение появляется мгновенно, статус меняется при доставке/чтении (если сервер шлет статусы).
- IMAGE: выбрать 1–3 изображения — отображается превью + подписи; по отправке изображения сжимаются (≈1200px, 0.7 JPEG) и уходят на сервер.
- PRODUCT: открыть `ChatRoom` с `route.params.productId` → кнопка «Отправить товар» в header — сообщение с карточкой товара появляется в ленте.

### 4. Удаление/скрытие сообщений
- Отправить сообщение как Client A → удалить «у себя» (если UI предусмотрен) — сообщение исчезает только у Client A.
- Как Admin — удалить «у всех» сообщение Client A — пропадает у всех клиентов.
- Убедиться, что сокет-событие `chat:message:deleted` обновляет ленту без ручного рефреша.

### 5. PRODUCT-чат из карточки товара
- Открыть `ProductDetail` → нажать «Задать вопрос» → происходит `getOrCreateProductRoom` и переход в `ChatRoom`.
- Отправить текст/изображение — проверить, что в ленте корректно отображается привязка к товару (если сервер добавляет контекст).

### 6. Непрочитанные/markAsRead
- Получить сообщение в неактивной комнате — бейдж/счетчик непрочитанного увеличивается (если сервер отдает счетчик/или локально инкремент).
- Открыть комнату — `markAsRead` уходит на сервер; локальный счетчик в state сбрасывается.

### 7. Typing-индикатор
- В другом клиенте начать ввод — появляется `typing` для текущей комнаты, исчезает по таймауту/окончанию печати.

### 8. Кэш и перезапуск
- Убедиться, что после перезапуска приложения `ChatList` и последние N сообщений комнаты отображаются из кэша без видимых задержек, затем обновляются с сервера.

## Ошибки и устойчивость

### 401 (просроченный токен)
- Инициировать истечение `accessToken` (либо вручную в dev) → убедиться, что глобальный перехватчик обновляет токен/просит релогин.
- При вызове методов чата (rooms/messages/send) должны корректно обрабатываться 401 без «молчаливых» зависаний.

### 429 (rate limit)
- Быстро отправить > N сообщений подряд (порог задан на сервере) → ожидать ответ 429.
- Приложение должно отобразить дружелюбный тост/сообщение «Слишком много сообщений. Попробуйте позже.» (в MVP достаточно логов; для UX — тост).

### Офлайн
- Отключить интернет → `ChatList`/`ChatRoom` показывают кэш; новые запросы не падают с крэшем.
- При восстановлении сети — новые сообщения приходят по сокету/или подтягиваются при повторном входе.

## E2E (smoke)
1. Войти под Client A.
2. Создать/открыть комнату с Client B (или PRODUCT-чат из карточки товара).
3. Отправить TEXT, IMAGE, PRODUCT — подтвердить, что у Client B всё отображается корректно.
4. Удалить одно из сообщений «у себя» → подтвердить поведение.
5. Зайти под Admin и удалить любое сообщение «у всех» → подтвердить синхронность удаления.

## Замечания
- Для IMAGE — на Android пути файлов должны содержать `file://`. В слое отправки это учтено.
- Для PRODUCT — при навигации можно передавать `navigation.navigate('ChatRoom', { roomId, productId })` для краткой кнопки в header.
- Для UI-ошибок — в MVP логирование в консоль достаточно; для продакшена рекомендованы тосты/баннеры.

