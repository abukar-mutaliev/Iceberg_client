# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –Ω–∞ iOS —á–µ—Ä–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏—é

## –ü—Ä–æ–±–ª–µ–º–∞

–ù–∞ iPhone –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
ERROR Error in GET /api/stops/all: Network Error
ERROR "_response": "resource exceeds maximum size"
```

iOS –Ω–µ –º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª—å—à–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö —á–µ—Ä–µ–∑ XMLHttpRequest.

## –ü—Ä–∏—á–∏–Ω–∞

1. Endpoint `/api/stops/all` –≤–æ–∑–≤—Ä–∞—â–∞–ª –≤—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ä–∞–∑—É –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
2. –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª–∞ –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
3. –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ iOS –Ω–µ –º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç

## –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏** —Å –ø–æ–¥–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (infinite scroll).

### 1. –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å

**–§–∞–π–ª:** `server/src/controllers/stop/stop.controller.js`

–ò–∑–º–µ–Ω–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ `limit` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
```javascript
// –ë—ã–ª–æ: const limit = parseInt(req.query.limit) || 5;
// –°—Ç–∞–ª–æ: const limit = parseInt(req.query.limit) || 20;
```

–°–µ—Ä–≤–µ—Ä —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π:
```javascript
{
  status: 'success',
  data: [...], // –º–∞—Å—Å–∏–≤ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
  pagination: {
    page: 1,
    limit: 20,
    total: 150,
    totalPages: 8
  }
}
```

### 2. Redux State (mobile/src/entities/stop/model/slice.js)

#### –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ initialState:
```javascript
const initialState = {
    stops: [],
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    // –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏:
    currentPage: 1,
    totalPages: 1,
    totalCount: 0,
    hasMore: true,
    isLoadingMore: false,
};
```

#### –û–±–Ω–æ–≤–ª–µ–Ω thunk fetchAllStops:
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `page`, `loadMore`
- –ö—ç—à —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `loadMore=false`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞

#### –û–±–Ω–æ–≤–ª–µ–Ω—ã reducers:
- **fetchAllStops.pending**: —Ä–∞–∑–ª–∏—á–∞–µ—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏ –ø–æ–¥–≥—Ä—É–∑–∫—É (loading vs isLoadingMore)
- **fetchAllStops.fulfilled**: 
  - –ü—Ä–∏ `loadMore=true` –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
  - –ü—Ä–∏ `loadMore=false` –∑–∞–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
  - –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (currentPage, totalPages, hasMore)
- **clearStopCache**: —Ç–µ–ø–µ—Ä—å —Ç–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏

### 3. –°–µ–ª–µ–∫—Ç–æ—Ä—ã (mobile/src/entities/stop/model/selectors.js)

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã:
```javascript
export const selectStopCurrentPage = (state) => state.stop?.currentPage || 1;
export const selectStopTotalPages = (state) => state.stop?.totalPages || 1;
export const selectStopTotalCount = (state) => state.stop?.totalCount || 0;
export const selectStopHasMore = (state) => state.stop?.hasMore || false;
export const selectStopIsLoadingMore = (state) => state.stop?.isLoadingMore || false;
```

### 4. API Layer (mobile/src/entities/stop/api/stopApi.js)

–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
```javascript
const requestParams = {
    limit: 20, // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 5 –¥–æ 20
    page: 1,
    ...params
};
```

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
- –ó–∞–ø—Ä–æ—Å—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- –£—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏

### 5. UI Component (mobile/src/screens/stop/ui/StopsListScreen/ui/StopsListScreen.jsx)

#### –ó–∞–º–µ–Ω–µ–Ω ScrollView –Ω–∞ FlatList:

**–ë—ã–ª–æ:**
```jsx
<ScrollView>
  {filteredStops.map(stop => <StopCard key={stop.id} stop={stop} />)}
</ScrollView>
```

**–°—Ç–∞–ª–æ:**
```jsx
<FlatList
  data={filteredStops}
  renderItem={renderStopItem}
  keyExtractor={keyExtractor}
  ListHeaderComponent={renderListHeader}
  ListFooterComponent={renderListFooter}
  ListEmptyComponent={renderEmptyComponent}
  onEndReached={handleLoadMore} // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
  onEndReachedThreshold={0.5}
  refreshControl={...}
/>
```

#### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

**loadStops:**
```javascript
const loadStops = useCallback(() => {
    dispatch(clearStopCache());
    dispatch(fetchAllStops({ districtId: selectedDistrictId, page: 1, loadMore: false }));
}, [dispatch, selectedDistrictId]);
```

**handleLoadMore:**
```javascript
const handleLoadMore = useCallback(() => {
    // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    if (isLoadingMore || !hasMore || loading || debouncedSearchQuery.trim() !== '') {
        return;
    }
    
    const nextPage = currentPage + 1;
    dispatch(fetchAllStops({ districtId: selectedDistrictId, page: nextPage, loadMore: true }));
}, [dispatch, selectedDistrictId, currentPage, hasMore, isLoadingMore, loading, debouncedSearchQuery]);
```

**handleDistrictSelect:**
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫—ç—à –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–≤–æ–≥–æ —Ä–∞–π–æ–Ω–∞
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Ä–∞–π–æ–Ω—É

**renderListFooter:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø–æ–¥–≥—Ä—É–∑–∫–µ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

#### –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏:
```javascript
flatList: { flex: 1 },
emptyListContent: { flexGrow: 1 },
loadingMoreContainer: {
    paddingVertical: 20,
    alignItems: 'center',
    flexDirection: 'row',
},
loadingMoreText: {
    marginLeft: 10,
    fontSize: FontSize.size_md,
    color: Color.gray,
}
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –æ—à–∏–±–∫–∞ "resource exceeds maximum size"** –Ω–∞ iOS
2. ‚úÖ **–ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 20 –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
3. ‚úÖ **–ü–ª–∞–≤–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞** - –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
4. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏** - –Ω–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—Ä–∞–∑—É
5. ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX** - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø–æ–¥–≥—Ä—É–∑–∫–µ
6. ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏** - –ø–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Ä–∞–π–æ–Ω–∞–º
7. ‚úÖ **Pull-to-refresh** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:
1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `loadStops()`
2. –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à ‚Üí `clearStopCache()`
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí `fetchAllStops({ page: 1, loadMore: false })`
4. –î–∞–Ω–Ω—ã–µ –∑–∞–º–µ–Ω—è—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤ state

### –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∏—Ç –¥–æ –∫–æ–Ω—Ü–∞ —Å–ø–∏—Å–∫–∞ ‚Üí —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `onEndReached`
2. –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —É—Å–ª–æ–≤–∏—è (–Ω–µ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞, –µ—Å—Ç—å –µ—â–µ –¥–∞–Ω–Ω—ã–µ)
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí `fetchAllStops({ page: currentPage + 1, loadMore: true })`
4. –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞–π–æ–Ω—É:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–∞–π–æ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ
2. –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º ‚Üí `fetchAllStops({ districtId, page: 1, loadMore: false })`

### Pull-to-refresh:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—è–Ω–µ—Ç –≤–Ω–∏–∑ —ç–∫—Ä–∞–Ω
2. –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí `fetchAllStops({ page: 1, loadMore: false })`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ iOS:
1. –û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–µ 20 –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
3. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑ - –¥–æ–ª–∂–Ω—ã –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–µ 20
4. –ü–æ—Ç—è–Ω—É—Ç—å –≤–Ω–∏–∑ (pull-to-refresh) - –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–Ω–æ–≤–æ
5. –í—ã–±—Ä–∞—Ç—å —Ä–∞–π–æ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ - –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ —Ä–∞–π–æ–Ω–∞
6. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ - –ø–æ–¥–≥—Ä—É–∑–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫)

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```javascript
console.log('üì° Fetching stops with params:', requestParams);
console.log('‚úÖ Stops fetched successfully:', { count, page, totalPages, total });
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. –î–æ–±–∞–≤–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
3. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î)

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

22 –¥–µ–∫–∞–±—Ä—è 2025 –≥–æ–¥–∞


