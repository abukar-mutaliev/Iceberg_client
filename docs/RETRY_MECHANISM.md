# –ú–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (Retry Mechanism)

## –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- **–î–æ 5 –ø–æ–ø—ã—Ç–æ–∫** –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ —Å —Ñ–æ—Ç–æ)
- **–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: 1—Å, 2—Å, 4—Å, 8—Å, 10—Å (–º–∞–∫—Å–∏–º—É–º)
- **–£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** –æ—à–∏–±–æ–∫, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–∞

### 2. UI –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–æ–ø—ã—Ç–∫–∏: "–ü–æ–ø—ã—Ç–∫–∞ 2 –∏–∑ 5..."
- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" –µ—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã

### 3. –¢–∏–ø—ã –æ—à–∏–±–æ–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö retry

#### –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏:
- `ERR_NETWORK` - –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- `Network Error` - –æ–±—â–∞—è —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞
- `ECONNABORTED` - –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- Timeout –æ—à–∏–±–∫–∏

#### –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏:
- `5xx` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–µ—Ä–≤–µ—Ä–∞
- `408` - Request Timeout
- `429` - Too Many Requests (rate limiting)

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π retry –¥–ª—è –ª—é–±–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

```javascript
import { retryRequest } from '@shared/api/retryHelper';

const result = await retryRequest(
  () => apiCall(),
  {
    maxRetries: 3,
    onRetry: (attempt, error) => {
      console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt}`);
    }
  }
);
```

### Retry –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

```javascript
import { retryFileUpload } from '@shared/api/retryHelper';

const result = await retryFileUpload(
  () => uploadFile(formData),
  {
    maxRetries: 5, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ñ–∞–π–ª–æ–≤
    onRetry: (attempt, error) => {
      showToast(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${attempt}/5...`);
    }
  }
);
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Redux Thunk

```javascript
export const createStop = createAsyncThunk(
  'stop/createStop',
  async (stopData, { rejectWithValue }) => {
    // Callback –¥–ª—è UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    const onRetryCallback = stopData.onRetry;
    
    // –£–¥–∞–ª—è–µ–º callback –∏–∑ –¥–∞–Ω–Ω—ã—Ö
    const actualStopData = { ...stopData };
    delete actualStopData.onRetry;
    
    // API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç retry
    const response = await stopApi.createStop(formData, onRetryCallback);
    return response.data;
  }
);
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```javascript
const handleSubmit = async () => {
  const [retryCount, setRetryCount] = useState(0);
  
  // Callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
  const onRetryCallback = (attempt, error) => {
    setRetryCount(attempt);
    showInfo(`üì∂ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${attempt} –∏–∑ 5...`);
  };

  // –ü–µ—Ä–µ–¥–∞–µ–º callback –≤ –¥–∞–Ω–Ω—ã–µ
  const stopDataWithRetry = {
    ...stopData,
    onRetry: onRetryCallback
  };

  await dispatch(createStop(stopDataWithRetry));
};
```

## –§–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
- `mobile/src/shared/api/retryHelper.js` - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è retry
- `mobile/src/entities/stop/api/stopApi.js` - API —Å retry –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
- `mobile/src/entities/stop/model/slice.js` - Redux thunk —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π retry
- `mobile/src/features/driver/addDriverStop/ui/StopForm.jsx` - UI —Å –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π retry

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é
2. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤
4. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –ª—é–±—ã–º API –∑–∞–ø—Ä–æ—Å–∞–º
5. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ì–∏–±–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã retry –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ retry –ø–æ–ø—ã—Ç–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
```
üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ 2/5
  error: "Network Error"
  code: "ERR_NETWORK"
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è retry –º–µ—Ö–∞–Ω–∏–∑–º–∞:
1. –í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º "Airplane mode" –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É
3. –ß–µ—Ä–µ–∑ 2-3 —Å–µ–∫—É–Ω–¥—ã –≤—ã–∫–ª—é—á–∏—Ç–µ "Airplane mode"
4. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–µ—Ç–∏
- [ ] Offline queue –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ retry

